name: Generate Changelog for Pull Request

on:
  pull_request:
    branches: [ master ]  # Workflow wird nur für PRs auf den 'master' Branch ausgeführt
    types: [opened, synchronize]

jobs:
  generate_changelog:
    runs-on: ubuntu-latest
    name: Generate Changelog for PR Commits

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Holt das gesamte Repository mit allen Branches

    - name: Generate Changelog Entry
      run: |
        # Datum nur einmal setzen
        DATE=$(date +"%d.%m.%Y")
        
        # Leere Datei erstellen (wenn sie nicht existiert)
        if [ ! -f CHANGELOG.md ]; then
          touch CHANGELOG.md
        fi
        
        # Alle gefilterten Commits mit # sammeln (die mit # beginnen, ohne Merge-Commits)
        COMMITS=$(git log $(git merge-base origin/master HEAD)..HEAD --pretty=format:"%s" --no-merges | grep "^#")
        
        # Überprüfen, ob es gefilterte Commits gibt
        if [ -z "$COMMITS" ]; then
          echo "No filtered commits found, skipping changelog update."
          exit 0
        fi

        # Datum einmal in die Changelog-Datei einfügen
        echo "$DATE" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # Gefilterte Commits (mit #) in die Datei einfügen
        echo "$COMMITS" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # Bestehende CHANGELOG.md Datei an die neue anhängen
        # Keine Duplikate durch mehrfaches Hinzufügen des Datums
        git checkout ${{ github.event.pull_request.base.ref }}
        git add CHANGELOG.md
        git commit -m "Update changelog for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
        git push origin HEAD:${{ github.head_ref }}

    - name: Comment on Pull Request with Changelog
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        header: changelog
        message: |
          ## Changelog
          ```markdown
          ${{ env.changelog_content }}
          ```
