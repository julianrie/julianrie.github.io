name: Generate JSON Changelog for Pull Request

on:
  pull_request:
    branches: [ master ]  # Workflow wird nur für PRs auf den 'master' Branch ausgeführt
    types: [opened, synchronize]

jobs:
  generate_changelog:
    runs-on: ubuntu-latest
    name: Generate JSON Changelog for PR Commits

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Holt das gesamte Repository mit allen Branches

    - name: Generate JSON Changelog Entry
      run: |
        # Aktuelles Datum im Format DD.MM.YYYY
        DATE=$(date +"%d.%m.%Y")
        
        # Beginne JSON-Datei und füge Datum ein
        echo "{ \"date\": \"$DATE\", \"commits\": [" > new_changelog.json

        # Füge die Commit-Titel (nur mit # beginnende) als JSON-Array-Elemente hinzu
        git log $(git merge-base origin/master HEAD)..HEAD --pretty=format:"\"%s\"" --no-merges | grep "^#" | sed 's/.*/{ \"message\": & },/' >> new_changelog.json

        # Schließe JSON-Struktur und entferne letztes Komma, falls nötig
        sed -i '$ s/,$//' new_changelog.json
        echo "]}" >> new_changelog.json

        # Bestehende CHANGELOG.json anfügen, falls vorhanden
        if test -f CHANGELOG.json; then
          jq -s '.[0] * .[1]' new_changelog.json CHANGELOG.json > merged_changelog.json
          mv merged_changelog.json CHANGELOG.json
        else
          mv new_changelog.json CHANGELOG.json
        fi

    - name: Commit and Push JSON Changelog
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add CHANGELOG.json
        git commit -m "Update changelog for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
        git push origin HEAD:${{ github.head_ref }}

    - name: Comment on Pull Request with JSON Changelog
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        header: changelog
        message: |
          ## JSON Changelog
          ```json
          ${{ env.changelog_content }}
          ```
